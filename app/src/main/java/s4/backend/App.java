/*
 * This source file was generated by the Gradle 'init' task
 */
package s4.backend;


import org.apache.commons.io.IOUtils;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.http.ResponseEntity;
import org.springframework.boot.SpringApplication;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestPart;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.oauth2.jwt.Jwt;

import org.json.JSONObject;

import java.io.BufferedOutputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.Instant;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import java.util.stream.Stream;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import s4.backend.data.PhotoData;
import s4.backend.repositories.PhotoDataRepository;


@RestController
@SpringBootApplication
public class App {
    @Autowired 
    private PhotoDataRepository photoDataRepo; 

    private Path upload_directory = Paths.get(System.getProperty("user.dir")+"/uploads");

    // TODO: delete
   	@RequestMapping("/")
    public String getGreeting() {
        System.out.print("Hello World!");
        return "Hello World!";
    }

    // TODO: add filter parameters: https://www.speakeasy.com/api-design/filtering-responses
    @GetMapping(value="/getimagesdata")
    public @ResponseBody ResponseEntity<List<PhotoData>> getImagesData(@AuthenticationPrincipal Jwt jwt) 
            throws IOException {

        return ResponseEntity
          .ok()
          .body(photoDataRepo.findAll()); 
    }

    // TODO: add filter parameters
    @GetMapping(value="/getimages", produces="application/zip")
    public @ResponseBody ResponseEntity<byte[]> getImages(@AuthenticationPrincipal Jwt jwt) 
            throws IOException {

        List<Path> result;
        try (Stream<Path> paths = Files.walk(upload_directory)) {
            result = paths
                .filter(Files::isRegularFile)
                    .collect(Collectors.toList());
        } 

        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        BufferedOutputStream bufferedOutputStream = new BufferedOutputStream(byteArrayOutputStream);
        ZipOutputStream zos = new ZipOutputStream(bufferedOutputStream);
        
        for (Path path : result){
            File file = new File(path.toString());
            zos.putNextEntry(new ZipEntry(file.getName()));
            FileInputStream fileInputStream = new FileInputStream(file);

            IOUtils.copy(fileInputStream, zos);

            fileInputStream.close();
            zos.closeEntry();
        }

        zos.finish();
        zos.flush();
        IOUtils.closeQuietly(zos);
        IOUtils.closeQuietly(bufferedOutputStream);
        IOUtils.closeQuietly(byteArrayOutputStream);
        
        return ResponseEntity
          .ok()
          .header("Content-Disposition", "attachment; filename=\"image_files.zip\"")
          .body(byteArrayOutputStream.toByteArray());
    }

    @PostMapping("/upload")
    public @ResponseBody ResponseEntity<String> uploadData(@RequestPart("json") String json, 
                             @RequestPart("image") MultipartFile image, 
                             @AuthenticationPrincipal Jwt jwt) throws Exception {


        // Convert MultipartFile -> String
        String jsonString = new String(json.getBytes(), StandardCharsets.UTF_8);

        String debug = uploadImageAndData(jsonString, image);

        // TODO: currently returns a debug string. need to change, probably to success/fail
        return ResponseEntity.ok().body(debug);                        
    }
 
    public static void main(String[] args) {
        SpringApplication.run(App.class, args);
    }


    private String uploadImageAndData(String jsonString, MultipartFile image) throws IOException
    {
        StringBuilder debug = new StringBuilder();
        JSONObject jsonObj = new JSONObject(jsonString.toString());

        PhotoData data = new PhotoData(jsonObj);

        //saved_entity contains inserted data and its new ID so use that for other insertions
        PhotoData saved_entity = photoDataRepo.save(data);
        String image_name = upload_directory + "//" + Long.toString(saved_entity.getId()) + ".png";

        Files.write(Paths.get(image_name), image.getBytes());

        List<Path> result;
        try (Stream<Path> paths = Files.walk(upload_directory)) {
            result = paths
                .filter(Files::isRegularFile)
                    .collect(Collectors.toList());
        } 

        // TODO: delete and swap to success/fail when finished with authentication
        debug.append(saved_entity.toString() + " | ");
        debug.append(result.toString() + " | ");
        debug.append(image.getBytes().length + " | ");
        debug.append(Paths.get(image_name).toString() + " | ");

        return debug.toString();
    }
}
